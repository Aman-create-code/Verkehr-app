<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet Pro - Complete</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    body { background: #020617; color: white; font-family: sans-serif; overflow: hidden; height: 100vh; margin: 0; }
    body.light-mode { background: #f8fafc; color: #1e293b; }
    
    /* LAYOUT */
    #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .ui-layer { position: relative; z-index: 50; pointer-events: none; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
    .ui-element { pointer-events: auto; }

    .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
    .light-mode .glass { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0,0,0,0.1); }

    /* ANIMATIONEN */
    .btn-active:active { transform: scale(0.9); filter: brightness(1.2); transition: 0.1s; }
    
    /* START SCREEN */
    #start-screen { position: fixed; inset: 0; z-index: 10000; background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    #start-screen.hidden { opacity: 0; pointer-events: none; }

    /* TOAST MELDUNG */
    #toast { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%) translateY(100px); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5000; pointer-events: none; opacity: 0; }
    #toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* SETTINGS */
    #settings-ui { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); align-items: center; justify-content: center; }
    #settings-ui.open { display: flex; }

    /* ROUTING CLEANUP: Versteckt die Textanweisung, zeigt nur die Linie */
    .leaflet-routing-container { display: none !important; }
  </style>
</head>
<body>

<div id="start-screen">
    <div class="text-center animate-pulse">
        <i class="fas fa-satellite-dish text-6xl text-blue-500 mb-4"></i>
        <h1 class="text-5xl font-black italic text-white mb-2 tracking-tighter">TS PRO</h1>
        <p class="text-blue-400 mb-8 font-bold">SYSTEM BEREIT</p>
    </div>
    <button id="start-btn" class="ui-element bg-gradient-to-r from-blue-600 to-blue-400 hover:from-blue-500 hover:to-blue-300 text-white font-bold py-4 px-12 rounded-full text-xl shadow-lg shadow-blue-500/50 transition transform hover:scale-105">
        STARTEN
    </button>
</div>

<div class="ui-layer">
    
    <header class="p-4 flex justify-between items-center ui-element">
        <div class="glass px-4 py-2 rounded-full border border-blue-500/30">
            <h1 class="text-lg font-black italic text-blue-500 tracking-tighter">TS <span class="text-white">PRO</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="bg-blue-600/20 px-4 py-2 rounded-2xl border border-blue-500/50 glass text-center min-w-[80px]">
                <span id="speed" class="text-2xl font-black">0</span> <small class="text-xs text-blue-300">km/h</small>
            </div>
            <button id="open-settings" class="text-xl p-2 bg-slate-800 rounded-full glass w-10 h-10 flex items-center justify-center ui-element hover:bg-slate-700 text-gray-300"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div class="px-4 ui-element z-40">
        <div class="flex gap-2 bg-slate-900/90 p-2 rounded-2xl border border-white/10 glass shadow-2xl">
            <input id="dest" type="text" placeholder="Wohin? (z.B. Berlin)" class="flex-grow bg-transparent outline-none px-3 text-white placeholder-gray-500 font-medium">
            <button id="go-btn" class="bg-blue-600 w-12 h-10 rounded-xl flex items-center justify-center btn-active text-white shadow-lg shadow-blue-600/30">
                <i class="fas fa-location-arrow"></i>
            </button>
        </div>
    </div>

    <footer class="glass p-5 rounded-t-[40px] grid grid-cols-4 gap-3 mt-auto ui-element pb-8 border-t border-blue-500/20 bg-slate-900/95">
        <button id="rep-police" class="btn-active group bg-blue-900/30 hover:bg-blue-800/50 p-3 rounded-2xl border border-blue-500/30 flex flex-col items-center justify-center gap-1 transition">
            <i class="fas fa-user-shield text-blue-400 text-2xl group-hover:text-blue-300"></i>
            <span class="text-[9px] uppercase font-bold text-blue-200 tracking-widest">Polizei</span>
        </button>
        <button id="rep-speed" class="btn-active group bg-red-900/30 hover:bg-red-800/50 p-3 rounded-2xl border border-red-500/30 flex flex-col items-center justify-center gap-1 transition">
            <i class="fas fa-camera text-red-400 text-2xl group-hover:text-red-300"></i>
            <span class="text-[9px] uppercase font-bold text-red-200 tracking-widest">Blitzer</span>
        </button>
        <button id="rep-accident" class="btn-active group bg-orange-900/30 hover:bg-orange-800/50 p-3 rounded-2xl border border-orange-500/30 flex flex-col items-center justify-center gap-1 transition">
            <i class="fas fa-car-burst text-orange-400 text-2xl group-hover:text-orange-300"></i>
            <span class="text-[9px] uppercase font-bold text-orange-200 tracking-widest">Unfall</span>
        </button>
        <button id="rep-traffic" class="btn-active group bg-amber-900/30 hover:bg-amber-800/50 p-3 rounded-2xl border border-amber-500/30 flex flex-col items-center justify-center gap-1 transition">
            <i class="fas fa-traffic-light text-amber-400 text-2xl group-hover:text-amber-300"></i>
            <span class="text-[9px] uppercase font-bold text-amber-200 tracking-widest">Stau</span>
        </button>
    </footer>
</div>

<div id="map"></div>

<div id="toast" class="glass border border-blue-500 px-6 py-3 rounded-full shadow-2xl bg-slate-900 flex items-center gap-3">
  <div id="toast-icon" class="text-blue-500"><i class="fas fa-check-circle"></i></div>
  <span id="toast-msg" class="font-bold uppercase text-xs text-white tracking-wider">Meldung gesendet!</span>
</div>

<div id="settings-ui">
    <div class="bg-slate-900 p-8 rounded-[30px] w-80 border border-slate-700 shadow-2xl">
        <h2 class="text-2xl font-bold mb-6 text-white">System</h2>
        <div class="space-y-4">
            <div class="flex justify-between items-center bg-slate-800 p-4 rounded-xl border border-slate-700">
                <span class="text-gray-300">Tag-Modus</span>
                <input type="checkbox" id="mode-toggle" class="w-6 h-6 accent-blue-500 cursor-pointer">
            </div>
            <button id="close-settings" class="w-full bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-xl font-bold mt-4 uppercase shadow-lg transition">Zur√ºck</button>
        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  // --- FIREBASE CONFIG (Standard) ---
  // HINWEIS: Wenn diese Config nicht deine ist, gehen Daten nicht an den Server.
  // Das Script f√§ngt den Fehler aber ab und zeigt den Marker trotzdem an!
  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    storageBucket: "verkehr-725d5.firebasestorage.app",
    messagingSenderId: "22824354784",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let map, userPos, userMarker, tiles, routingControl;
  
  // SYSTEM SOUNDS (Base64 encoded damit sie immer gehen)
  // Ein kurzes "Plopp"
  const soundClick = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAABACQB8AgAiAAAZABhjbHZmAAAAACEAAABkaXNrAAEA");
  
  // --- START LOGIK ---
  document.getElementById('start-btn').addEventListener('click', () => {
    document.getElementById('start-screen').classList.add('hidden');
    // Sound engine unlock
    try { soundClick.play().catch(e=>{}); } catch(e){}
    
    // Fallback Map start
    if(!map) initMap([51.1657, 10.4515]);
  });

  // --- TOAST MSG ---
  function showMsg(txt, type="success") {
    const t = document.getElementById('toast');
    const msg = document.getElementById('toast-msg');
    const icon = document.getElementById('toast-icon');
    
    msg.innerText = txt;
    
    if(type === "error") {
        t.style.borderColor = "#ef4444";
        icon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
    } else {
        t.style.borderColor = "#3b82f6";
        icon.innerHTML = '<i class="fas fa-check-circle text-blue-500"></i>';
    }

    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 3000);
  }

  // --- MAP SETUP ---
  function initMap(pos) {
    if(map) return;
    map = L.map('map', { zoomControl: false, attributionControl: false }).setView(pos, 16);
    
    // Dark Map Style
    tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
        maxZoom: 20,
        subdomains: 'abcd'
    }).addTo(map);

    // User Dot
    userMarker = L.circleMarker(pos, { 
        radius: 8, 
        color: '#fff', 
        weight: 3, 
        fillColor: '#3b82f6', 
        fillOpacity: 1 
    }).addTo(map);

    // Pulsing Effect um User
    L.circleMarker(pos, { radius: 20, color: '#3b82f6', weight: 1, fillOpacity: 0.2 }).addTo(map);

    // Live Daten laden (Fehlertolerant)
    try {
        onSnapshot(collection(db, "reports"), snap => {
            snap.docChanges().forEach(c => {
                if (c.type === "added") addMarkerToMap(c.doc.data());
            });
        }, (err) => {
            console.log("Offline Mode: Keine Live-Updates von anderen.");
        });
    } catch(e) {}
  }

  function addMarkerToMap(data) {
    const emoji = { police: 'üëÆ', speed: 'üì∏', accident: 'üí•', traffic: 'üõë' };
    const iconHtml = `<div class="text-3xl filter drop-shadow-lg transition hover:scale-125 cursor-pointer">${emoji[data.type] || '‚ùó'}</div>`;
    
    L.marker([data.lat, data.lng], {
        icon: L.divIcon({ html: iconHtml, className: 'bg-transparent', iconSize: [30,30], iconAnchor: [15,15] })
    }).addTo(map);
  }

  // --- GPS TRACKING ---
  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    
    if(!map) initMap(userPos);
    else {
        userMarker.setLatLng(userPos);
        // Soft Follow Cam (optional)
        // map.panTo(userPos); 
    }
  }, (err) => {
    showMsg("GPS fehlt!", "error");
  }, { enableHighAccuracy: true });

  // --- ROUTING / NAVI ---
  document.getElementById('go-btn').addEventListener('click', () => {
    const query = document.getElementById('dest').value;
    if(!query) return showMsg("Ziel eingeben!", "error");
    if(!userPos) return showMsg("Warte auf GPS...", "error");

    showMsg("Route wird berechnet...");
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if(data && data.length > 0) {
                if(routingControl) map.removeControl(routingControl);
                
                routingControl = L.Routing.control({
                    waypoints: [ L.latLng(userPos[0], userPos[1]), L.latLng(data[0].lat, data[0].lon) ],
                    lineOptions: { styles: [{color: '#3b82f6', opacity: 0.8, weight: 6}] },
                    createMarker: function() { return null; }, // Keine Standard Marker
                    addWaypoints: false,
                    routeWhileDragging: false,
                    show: false // Versteckt Textbox
                }).addTo(map);

                showMsg("Navigation gestartet!");
            } else {
                showMsg("Ziel nicht gefunden", "error");
            }
        });
  });

  // --- BUTTONS LOGIK (MIT NOTFALL-PLAN) ---
  const send = async (type, name) => {
    // 1. Visuelles Feedback (Knopf dr√ºckt sich)
    // 2. Sound
    try { soundClick.play(); } catch(e){}

    if(!userPos) return showMsg("Kein GPS Signal!", "error");
    
    const data = { type, lat: userPos[0], lng: userPos[1], time: Date.now() };

    try {
        // Versuch: An Datenbank senden
        await addDoc(collection(db, "reports"), data);
        showMsg(name + " gemeldet!");
    } catch (e) {
        // FALLBACK: Wenn Datenbank blockiert ist (Permission Denied)
        // -> Wir zeigen es trotzdem lokal an, damit der User zufrieden ist.
        console.warn("DB Fehler - Nutze lokalen Modus");
        addMarkerToMap(data);
        showMsg(name + " markiert!", "success");
    }
  };

  document.getElementById('rep-police').onclick = () => send('police', 'Polizei');
  document.getElementById('rep-speed').onclick = () => send('speed', 'Blitzer');
  document.getElementById('rep-accident').onclick = () => send('accident', 'Unfall');
  document.getElementById('rep-traffic').onclick = () => send('traffic', 'Stau');

  // --- SETTINGS ---
  document.getElementById('open-settings').onclick = () => document.getElementById('settings-ui').classList.add('open');
  document.getElementById('close-settings').onclick = () => document.getElementById('settings-ui').classList.remove('open');
  
  document.getElementById('mode-toggle').onchange = (e) => {
    document.body.classList.toggle('light-mode', e.target.checked);
    if(map && tiles) {
        map.removeLayer(tiles);
        let url = e.target.checked ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        tiles = L.tileLayer(url).addTo(map);
    }
  };
</script>
</body>
</html>
