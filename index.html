<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet Pro - GitHub Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <style>
    #map { height: calc(100vh - 300px); border-radius: 20px; margin: 10px; border: 1px solid #1e293b; }
    .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
    .btn-action { transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
    .btn-action:active { transform: scale(0.9); }
    body { background-color: #020617; color: white; font-family: sans-serif; }
  </style>
</head>
<body>

<div id="danger-bar" class="hidden bg-red-600 p-2 text-center font-bold animate-pulse z-[3000]">
  ‚ö†Ô∏è GEFAHR IN DER N√ÑHE!
</div>

<header class="p-4 glass sticky top-0 z-[1000] border-b border-white/10">
  <div class="max-w-md mx-auto flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-black italic text-blue-500 tracking-tighter">TRAFFIC SWEET</h1>
      <p class="text-[10px] text-slate-400">LIVE COMMUNITY DASHBOARD</p>
    </div>
    <div class="text-right">
      <div class="text-2xl font-mono font-bold"><span id="speed-val">0</span> <span class="text-sm text-blue-400">km/h</span></div>
      <div class="text-[9px] text-slate-500">DISTANZ: <span id="dist-val">0.0</span> km</div>
    </div>
  </div>
</header>

<div class="p-3 max-w-md mx-auto">
  <div class="flex gap-2 bg-slate-900 p-2 rounded-xl border border-slate-700">
    <input id="nav-target" placeholder="Zielort eingeben..." class="flex-grow bg-transparent outline-none text-sm px-2">
    <button onclick="startNavigation()" class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-route"></i></button>
  </div>
</div>

<div id="map"></div>

<footer class="p-4 glass rounded-t-[30px] border-t border-white/10 mt-auto">
  <div class="grid grid-cols-4 gap-3 max-w-md mx-auto">
    <button onclick="makeReport('police')" class="btn-action bg-indigo-600/20 p-3 rounded-2xl flex flex-col items-center">
      <i class="fas fa-shield-halved text-indigo-400 text-xl mb-1"></i>
      <span class="text-[9px] font-bold">POLIZEI</span>
    </button>
    <button onclick="makeReport('speed')" class="btn-action bg-red-600/20 p-3 rounded-2xl flex flex-col items-center">
      <i class="fas fa-camera text-red-400 text-xl mb-1"></i>
      <span class="text-[9px] font-bold">BLITZER</span>
    </button>
    <button onclick="makeReport('accident')" class="btn-action bg-orange-600/20 p-3 rounded-2xl flex flex-col items-center">
      <i class="fas fa-car-burst text-orange-400 text-xl mb-1"></i>
      <span class="text-[9px] font-bold">UNFALL</span>
    </button>
    <button onclick="makeReport('traffic')" class="btn-action bg-amber-500/20 p-3 rounded-2xl flex flex-col items-center text-amber-400">
      <i class="fas fa-traffic-light text-xl mb-1"></i>
      <span class="text-[9px] font-bold">STAU</span>
    </button>
  </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  // DEINE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    storageBucket: "verkehr-725d5.firebasestorage.app",
    messagingSenderId: "22824354784",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let map, userPos, userMarker, routingControl;
  let markers = {};
  let totalDist = 0;
  let lastPos = null;

  // Icons Zuordnung
  const emoji = { police: 'üöì', speed: 'üì∏', accident: 'üí•', traffic: 'üöó' };

  // 1. Standort-Logik
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      userPos = [lat, lng];

      // Speed & Distanz
      const speedKmh = Math.round((pos.coords.speed || 0) * 3.6);
      document.getElementById('speed-val').innerText = speedKmh;

      if (lastPos) {
        const d = L.latLng(lat, lng).distanceTo(L.latLng(lastPos[0], lastPos[1]));
        totalDist += d / 1000;
        document.getElementById('dist-val').innerText = totalDist.toFixed(2);
      }
      lastPos = userPos;

      if (!map) {
        initMap(userPos);
      } else {
        userMarker.setLatLng(userPos);
        checkDanger(userPos);
      }
    }, null, { enableHighAccuracy: true });
  }

  function initMap(pos) {
    map = L.map('map', { zoomControl: false }).setView(pos, 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    userMarker = L.circleMarker(pos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
    listenToDatabase();
  }

  // 2. Datenbank-Funktionen (Global verf√ºgbar machen)
  window.makeReport = async (type) => {
    if (!userPos) return alert("Warte auf GPS...");
    try {
      await addDoc(collection(db, "reports"), {
        type, lat: userPos[0], lng: userPos[1], votes: 1, time: Date.now()
      });
      console.log("Gemeldet: " + type);
    } catch (e) { alert("Fehler: " + e.message); }
  };

  window.voteReport = async (id) => {
    const docRef = doc(db, "reports", id);
    await updateDoc(docRef, { votes: increment(1) });
  };

  function listenToDatabase() {
    onSnapshot(collection(db, "reports"), snap => {
      snap.docChanges().forEach(change => {
        const d = change.doc.data();
        const id = change.doc.id;

        if (change.type === "removed") {
          if (markers[id]) { map.removeLayer(markers[id]); delete markers[id]; }
        } else {
          // Nur Anzeigen wenn j√ºnger als 60 Min
          if (Date.now() - d.time > 3600000) return;

          if (markers[id]) {
            markers[id].setPopupContent(`<b>${d.type.toUpperCase()}</b><br>Votes: ${d.votes}`);
          } else {
            const m = L.marker([d.lat, d.lng], {
              icon: L.divIcon({ html: `<div class="text-3xl">${emoji[d.type]}</div>`, className: 'bg-transparent' })
            }).addTo(map);
            m.bindPopup(`
              <div class="text-black">
                <b class="uppercase">${d.type}</b><br>
                Best√§tigungen: ${d.votes}<br>
                <button onclick="voteReport('${id}')" class="bg-blue-600 text-white px-2 py-1 rounded mt-2 text-[10px]">Best√§tigen</button>
              </div>
            `);
            markers[id] = m;
          }
        }
      });
    });
  }

  // 3. Navigation & Gefahr
  window.startNavigation = async () => {
    const query = document.getElementById('nav-target').value;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (data[0]) {
      if (routingControl) map.removeControl(routingControl);
      routingControl = L.Routing.control({
        waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(data[0].lat, data[0].lon)],
        createMarker: () => null,
        lineOptions: { styles: [{ color: '#3b82f6', weight: 6 }] }
      }).addTo(map);
    }
  };

  function checkDanger(pos) {
    let close = false;
    Object.values(markers).forEach(m => {
      if (map.distance(pos, m.getLatLng()) < 500) close = true;
    });
    document.getElementById('danger-bar').classList.toggle('hidden', !close);
  }
</script>

</body>
</html>
