<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet - No Scroll Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* Verhindert jegliches Scrollen auf der ganzen Seite */
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      background: #020617; 
      font-family: sans-serif;
    }

    /* Flex-Container, der den gesamten Bildschirm f√ºllt */
    .app-wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /* Die Karte nimmt den verf√ºgbaren Platz flexibel ein */
    #map { 
      flex-grow: 1; 
      width: 100%;
      z-index: 1;
    }

    .glass { 
      background: rgba(15, 23, 42, 0.9); 
      backdrop-filter: blur(15px); 
      border-top: 1px solid rgba(255,255,255,0.1); 
    }

    /* Spezial-Styling f√ºr iPad/Tablet (Querformat) */
    @media (min-width: 1024px) {
      .app-wrapper { flex-direction: row; }
      header { width: 300px; height: 100%; flex-direction: column; border-right: 1px solid #334155; }
      footer { width: 120px; height: 100%; flex-direction: column !important; border-top: none; border-left: 1px solid #334155; }
      #map { height: 100% !important; }
    }

    .btn-pro {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .btn-pro:active { transform: scale(0.85); background: #3b82f6 !important; }

    /* HUD-Modus Spiegelung */
    .hud-mode { transform: scaleX(-1); }
  </style>
</head>
<body>

<div class="app-wrapper">
  <header class="p-4 flex justify-between items-center glass z-[100]">
    <div>
      <h1 class="text-xl font-black italic text-blue-500 tracking-tighter">TS ULTIMATE</h1>
      <div id="weather" class="text-[9px] text-slate-400 font-bold uppercase">GPS Suchen...</div>
    </div>
    <div class="flex items-center gap-3">
      <div class="bg-blue-900/50 px-4 py-1 rounded-xl border border-blue-500/30 text-center">
        <span id="speed" class="text-2xl font-black text-white">0</span>
        <span class="text-[8px] block -mt-1 font-bold text-blue-400">KM/H</span>
      </div>
      <button onclick="toggleHUD()" class="p-2 text-slate-400"><i class="fas fa-arrows-alt-h"></i></button>
    </div>
  </header>

  <div id="map"></div>

  <div class="p-3 glass z-[100]">
    <div class="flex gap-2 max-w-2xl mx-auto">
        <input id="target" placeholder="Ziel finden..." class="flex-grow bg-slate-800 rounded-xl px-4 text-sm text-white border border-slate-700 outline-none focus:border-blue-500">
        <button onclick="startNav()" class="bg-blue-600 p-3 rounded-xl btn-pro w-12"><i class="fas fa-location-arrow"></i></button>
    </div>
  </div>

  <footer class="p-4 glass flex justify-around items-center gap-2">
    <button onclick="rep('police')" class="btn-pro bg-blue-600/20 w-16 h-16 rounded-2xl border border-blue-500/30 flex items-center justify-center">
        <i class="fas fa-user-shield text-blue-400 text-xl"></i>
    </button>
    <button onclick="rep('speed')" class="btn-pro bg-red-600/20 w-16 h-16 rounded-2xl border border-red-500/30 flex items-center justify-center">
        <i class="fas fa-camera text-red-400 text-xl"></i>
    </button>
    <button onclick="rep('accident')" class="btn-pro bg-orange-600/20 w-16 h-16 rounded-2xl border border-orange-500/30 flex items-center justify-center">
        <i class="fas fa-car-burst text-orange-400 text-xl"></i>
    </button>
    <button onclick="rep('traffic')" class="btn-pro bg-amber-500/20 w-16 h-16 rounded-2xl border border-amber-500/30 flex items-center justify-center">
        <i class="fas fa-traffic-light text-amber-400 text-xl"></i>
    </button>
    <button onclick="location.href='tel:112'" class="btn-pro bg-white/10 w-16 h-16 rounded-2xl border border-white/20 flex items-center justify-center">
        <i class="fas fa-phone-alt text-white text-xl"></i>
    </button>
  </footer>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker;

  // Initialisierung
  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    
    if(!map) {
      map = L.map('map', { zoomControl: false }).setView(userPos, 15);
      // Dark Mode Tiles mit Verkehrs-Layer (OSM Standard zeigt Verkehr oft √ºber Subdomains)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
      userMarker = L.circleMarker(userPos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
      
      // Live Sync
      onSnapshot(collection(db, "reports"), snap => {
        snap.docChanges().forEach(c => {
          if (c.type === "added") {
            const d = c.doc.data();
            const iconMap = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è', traffic: 'üöó' };
            L.marker([d.lat, d.lng], {
              icon: L.divIcon({ html: `<div class="text-3xl">${iconMap[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'})
            }).addTo(map);
          }
        });
      });
      fetchWeather(userPos);
    } else {
      userMarker.setLatLng(userPos);
      map.panTo(userPos);
    }
  }, null, { enableHighAccuracy: true });

  async function fetchWeather(pos) {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos[0]}&longitude=${pos[1]}&current_weather=true`);
    const d = await r.json();
    document.getElementById('weather').innerText = `${d.current_weather.temperature}¬∞C ‚Ä¢ ${d.current_weather.windspeed} km/h Wind`;
  }

  window.rep = async (type) => {
    if(!userPos) return;
    await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
    const msg = new SpeechSynthesisUtterance("Meldung erfasst");
    msg.lang = 'de-DE';
    window.speechSynthesis.speak(msg);
  };

  window.toggleHUD = () => {
    document.body.classList.toggle('hud-mode');
  };

  window.startNav = async () => {
    const q = document.getElementById('target').value;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await res.json();
    if(data[0]) {
      L.Routing.control({
        waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(data[0].lat, data[0].lon)],
        createMarker: () => null,
        lineOptions: { styles: [{ color: '#3b82f6', weight: 6 }] }
      }).addTo(map);
    }
  };
</script>
</body>
</html>
