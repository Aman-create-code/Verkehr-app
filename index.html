<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet Ultimate v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <style>
    body { transition: background 0.3s, color 0.3s; background: #020617; color: white; overflow: hidden; }
    body.light { background: #f8fafc; color: #0f172a; }
    #map { height: calc(100vh - 380px); border-radius: 30px; margin: 15px; border: 2px solid rgba(59, 130, 246, 0.3); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); }
    .light .glass { background: rgba(255, 255, 255, 0.9); border-top: 1px solid rgba(0,0,0,0.1); }
    .menu-panel { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.8); backdrop-blur: 10px; align-items: center; justify-content: center; }
    .active { display: flex; }
    .leaflet-routing-container { display: none; } /* Wir bauen eigene Info-Box */
  </style>
</head>
<body class="flex flex-col h-screen">

<div id="audio-starter" onclick="startApp()" class="fixed inset-0 z-[10000] bg-blue-600 flex flex-col items-center justify-center text-center p-6">
  <i class="fas fa-play-circle text-6xl mb-4"></i>
  <h2 class="text-2xl font-bold">SYSTEM STARTEN</h2>
  <p>Tippe hier, um GPS und Sprachausgabe zu aktivieren</p>
</div>

<header class="p-4 flex justify-between items-center z-[500]">
  <div onclick="location.reload()">
    <h1 class="text-2xl font-black italic text-blue-500 tracking-tighter">TRAFFIC SWEET</h1>
    <div id="gps-status" class="text-[9px] text-red-500 font-bold uppercase"><i class="fas fa-circle"></i> No GPS</div>
  </div>
  <div class="flex items-center gap-3">
    <div class="bg-blue-600/20 px-3 py-1 rounded-full border border-blue-500/50">
        <span id="speed-display" class="text-xl font-black">0</span> <span class="text-[10px]">km/h</span>
    </div>
    <button onclick="toggleMenu()" class="p-2 text-2xl"><i class="fas fa-bars"></i></button>
  </div>
</header>

<div class="px-4 mb-2 z-[500]">
    <div class="flex gap-2 bg-slate-900/50 p-2 rounded-2xl border border-white/10 glass">
        <input id="target-input" placeholder="Ziel suchen..." class="flex-grow bg-transparent outline-none px-2 text-sm">
        <button onclick="goNav()" class="bg-blue-600 p-2 rounded-xl w-12"><i class="fas fa-route"></i></button>
    </div>
    <div id="route-stats" class="hidden flex justify-between mt-2 px-2 text-[10px] font-bold text-blue-400">
        <span id="eta-dist">0 km</span>
        <span id="eta-time">0 min</span>
    </div>
</div>

<div id="map"></div>

<footer class="glass p-5 rounded-t-[40px] mt-auto">
  <div class="grid grid-cols-4 gap-4 max-w-md mx-auto">
    <button onclick="sendRep('police')" class="flex flex-col items-center bg-blue-600/20 p-4 rounded-2xl border border-blue-500/30 active:scale-95"><i class="fas fa-user-shield text-blue-400"></i></button>
    <button onclick="sendRep('speed')" class="flex flex-col items-center bg-red-600/20 p-4 rounded-2xl border border-red-500/30 active:scale-95"><i class="fas fa-camera text-red-400"></i></button>
    <button onclick="sendRep('accident')" class="flex flex-col items-center bg-orange-600/20 p-4 rounded-2xl border border-orange-500/30 active:scale-95"><i class="fas fa-car-burst text-orange-400"></i></button>
    <button onclick="sendRep('sos')" class="flex flex-col items-center bg-white/10 p-4 rounded-2xl border border-white/20 active:scale-95"><i class="fas fa-phone text-white"></i></button>
  </div>
</footer>

<div id="menu" class="menu-panel">
  <div class="bg-slate-900 border border-slate-700 p-8 rounded-[40px] w-[85%] max-w-sm">
    <h2 class="text-2xl font-black mb-6 border-b border-white/10 pb-2">SETTINGS</h2>
    
    <div class="space-y-6">
      <div class="flex justify-between items-center">
        <span><i class="fas fa-sun mr-2"></i> Light Mode</span>
        <input type="checkbox" id="theme-switch" onchange="applySettings()" class="w-6 h-6">
      </div>
      <div class="flex justify-between items-center">
        <span><i class="fas fa-volume-up mr-2"></i> Sprach-Warnung</span>
        <input type="checkbox" id="voice-switch" checked class="w-6 h-6">
      </div>
      <div class="flex justify-between items-center">
        <span><i class="fas fa-satellite mr-2"></i> Satellit</span>
        <input type="checkbox" id="sat-switch" onchange="applySettings()" class="w-6 h-6">
      </div>
    </div>

    <button onclick="toggleMenu()" class="mt-10 w-full bg-blue-600 p-4 rounded-2xl font-black uppercase tracking-widest">Schlie√üen</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    storageBucket: "verkehr-725d5.firebasestorage.app",
    messagingSenderId: "22824354784",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let map, userPos, userMarker, routing, tiles;
  let markers = {};
  let warnedSet = new Set();

  // START APP & AUDIO
  window.startApp = () => {
    document.getElementById('audio-starter').style.display = 'none';
    speak("System bereit.");
    initGPS();
  };

  window.toggleMenu = () => document.getElementById('menu').classList.toggle('active');

  window.applySettings = () => {
    const isLight = document.getElementById('theme-switch').checked;
    const isSat = document.getElementById('sat-switch').checked;
    document.body.classList.toggle('light', isLight);
    
    if (map) {
      map.removeLayer(tiles);
      let url = isLight ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
      if (isSat) url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
      tiles = L.tileLayer(url).addTo(map);
    }
  };

  function speak(txt) {
    if (!document.getElementById('voice-switch').checked) return;
    const s = new SpeechSynthesisUtterance(txt);
    s.lang = 'de-DE';
    window.speechSynthesis.speak(s);
  }

  function initGPS() {
    navigator.geolocation.watchPosition(p => {
      userPos = [p.coords.latitude, p.coords.longitude];
      document.getElementById('speed-display').innerText = Math.round((p.coords.speed || 0) * 3.6);
      document.getElementById('gps-status').innerHTML = '<i class="fas fa-circle text-green-500"></i> GPS Active';

      if (!map) {
        map = L.map('map', { zoomControl: false }).setView(userPos, 16);
        tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        userMarker = L.circleMarker(userPos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
        syncData();
      } else {
        userMarker.setLatLng(userPos);
        checkProximity();
      }
    }, err => console.log(err), { enableHighAccuracy: true });
  }

  window.sendRep = async (type) => {
    if (!userPos) return;
    if (type === 'sos') return window.location.href = "tel:112";
    await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
    speak(type + " gemeldet. Danke!");
  };

  function syncData() {
    onSnapshot(collection(db, "reports"), snap => {
      snap.docChanges().forEach(change => {
        const d = change.doc.data();
        if (Date.now() - d.time < 3600000) {
           const iconMap = { police: 'üöì', speed: 'üì∏', accident: 'üí•' };
           L.marker([d.lat, d.lng], {
             icon: L.divIcon({ html: `<div class="text-3xl">${iconMap[d.type] || '‚ö†Ô∏è'}</div>`, className: 'bg-transparent' })
           }).addTo(map);
        }
      });
    });
  }

  window.goNav = async () => {
    const q = document.getElementById('target-input').value;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await r.json();
    if (data[0]) {
      if (routing) map.removeControl(routing);
      routing = L.Routing.control({
        waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(data[0].lat, data[0].lon)],
        createMarker: () => null,
        lineOptions: { styles: [{ color: '#3b82f6', weight: 8, opacity: 0.8 }] }
      }).on('routesfound', e => {
        const s = e.routes[0].summary;
        document.getElementById('route-stats').classList.remove('hidden');
        document.getElementById('eta-dist').innerText = (s.totalDistance/1000).toFixed(1) + " km";
        document.getElementById('eta-time').innerText = Math.round(s.totalTime/60) + " min";
        speak("Route berechnet. Entfernung " + (s.totalDistance/1000).toFixed(1) + " Kilometer.");
      }).addTo(map);
    }
  };

  function checkProximity() {
    // Logik f√ºr Sprachwarnung bei Blitzer in der N√§he (<500m)
    // Hier k√∂nnen wir markers-Objekt durchgehen
  }
</script>

</body>
</html>
