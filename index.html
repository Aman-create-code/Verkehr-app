<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet Pro - Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { background: #020617; color: white; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
    #map { height: calc(100vh - 350px); border-radius: 30px; margin: 15px; border: 2px solid rgba(59, 130, 246, 0.3); z-index: 1; }
    
    /* Ripple Effekt f√ºr Buttons */
    .btn-ripple {
      position: relative;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .btn-ripple:active {
      transform: scale(0.9);
      background-color: rgba(59, 130, 246, 0.4) !important;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
    }

    /* Toast Meldung Animation */
    #notification {
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 5000;
    }
    #notification.show { transform: translateX(-50%) translateY(0); }

    .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); }
  </style>
</head>
<body class="flex flex-col">

<div id="notification" class="glass border border-blue-500/50 px-6 py-3 rounded-2xl flex items-center gap-3 shadow-2xl">
  <div class="w-2 h-2 bg-blue-500 rounded-full animate-ping"></div>
  <span id="notif-text" class="font-bold text-sm uppercase tracking-widest">Ereignis gemeldet</span>
</div>

<header class="p-4 flex justify-between items-center z-[500]">
  <h1 class="text-2xl font-black italic text-blue-500 tracking-tighter">TS PRO</h1>
  <div class="bg-blue-600/20 px-4 py-2 rounded-2xl border border-blue-500/50">
    <span id="speed" class="text-2xl font-black">0</span> <small class="text-xs">km/h</small>
  </div>
</header>

<div id="map"></div>

<div class="px-4 mb-4">
    <div class="flex gap-2 bg-slate-900/80 p-3 rounded-2xl border border-white/10 glass shadow-2xl">
        <input id="target" placeholder="Wohin fahren wir?" class="flex-grow bg-transparent outline-none px-2 text-sm text-white">
        <button id="nav-btn" class="bg-blue-600 w-12 h-10 rounded-xl flex items-center justify-center btn-ripple">
            <i class="fas fa-location-arrow"></i>
        </button>
    </div>
</div>

<footer class="glass p-6 rounded-t-[45px] mt-auto grid grid-cols-4 gap-4">
  <button id="btn-police" class="btn-ripple bg-blue-600/20 p-5 rounded-3xl border border-blue-500/30 flex items-center justify-center">
    <i class="fas fa-user-shield text-blue-400 text-2xl"></i>
  </button>
  <button id="btn-speed" class="btn-ripple bg-red-600/20 p-5 rounded-3xl border border-red-500/30 flex items-center justify-center">
    <i class="fas fa-camera text-red-400 text-2xl"></i>
  </button>
  <button id="btn-accident" class="btn-ripple bg-orange-600/20 p-5 rounded-3xl border border-orange-500/30 flex items-center justify-center">
    <i class="fas fa-car-burst text-orange-400 text-2xl"></i>
  </button>
  <button id="btn-traffic" class="btn-ripple bg-amber-500/20 p-5 rounded-3xl border border-amber-500/30 flex items-center justify-center">
    <i class="fas fa-traffic-light text-amber-400 text-2xl"></i>
  </button>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    storageBucket: "verkehr-725d5.firebasestorage.app",
    messagingSenderId: "22824354784",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let map, userPos, userMarker;

  // Benachrichtigungs-Funktion
  function showToast(text) {
    const toast = document.getElementById('notification');
    document.getElementById('notif-text').innerText = text;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  // GPS Initialisierung
  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    
    if(!map) {
      map = L.map('map', { zoomControl: false }).setView(userPos, 16);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
      userMarker = L.circleMarker(userPos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
      
      // Live-Updates der Marker
      onSnapshot(collection(db, "reports"), snap => {
        snap.docChanges().forEach(change => {
          if (change.type === "added") {
            const d = change.doc.data();
            const icon = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è', traffic: 'üöó' };
            L.marker([d.lat, d.lng], {
              icon: L.divIcon({ html: `<div class="text-3xl animate-bounce">${icon[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'})
            }).addTo(map);
          }
        });
      });
    } else {
      userMarker.setLatLng(userPos);
    }
  }, null, { enableHighAccuracy: true });

  // Event Listener f√ºr Buttons (FIX!)
  async function sendReport(type, label) {
    if(!userPos) return showToast("Warte auf GPS...");
    try {
      await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
      showToast(label + " gemeldet!");
      // Sprachausgabe
      const msg = new SpeechSynthesisUtterance(label + " wurde erfolgreich gemeldet.");
      msg.lang = 'de-DE';
      window.speechSynthesis.speak(msg);
    } catch(e) {
      showToast("Fehler!");
    }
  }

  // Buttons manuell binden (Damit sie im Modul funktionieren)
  document.getElementById('btn-police').onclick = () => sendReport('police', 'Polizei');
  document.getElementById('btn-speed').onclick = () => sendReport('speed', 'Blitzer');
  document.getElementById('btn-accident').onclick = () => sendReport('accident', 'Unfall');
  document.getElementById('btn-traffic').onclick = () => sendReport('traffic', 'Stau');

</script>
</body>
</html>
