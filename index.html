<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TS PRO - Fixed Stability Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <style>
    :root { --p-blue: #3b82f6; --bg: #000; }
    
    body, html { 
      height: 100%; width: 100%; margin: 0; padding: 0;
      background: #000; color: white; overflow: hidden;
      font-family: -apple-system, system-ui, sans-serif;
    }

    /* Startbildschirm Fix */
    #start-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: #020617; display: flex; align-items: center; justify-content: center;
    }

    /* Grid-Struktur f√ºr absolute Sichtbarkeit */
    .main-wrapper {
      display: flex; flex-direction: column; height: 100vh; width: 100vw;
      visibility: hidden; position: relative;
    }
    .main-wrapper.active { visibility: visible; }

    /* Karten Fix - Muss Raum einnehmen */
    #map { 
      flex-grow: 1; width: 100%; height: 100%; 
      background: #111; z-index: 5;
    }

    /* UI Elemente */
    .ui-top { position: absolute; top: 0; left: 0; right: 0; z-index: 100; pointer-events: none; }
    .ui-bottom { position: absolute; bottom: 0; left: 0; right: 0; z-index: 100; pointer-events: none; }
    
    .interactive { pointer-events: auto !important; }

    .action-btn {
      width: 72px; height: 72px; border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      background: #1e293b; border: 2px solid rgba(255,255,255,0.1);
      cursor: pointer; touch-action: manipulation;
    }
    .action-btn:active { background: #3b82f6; transform: scale(0.95); }

    #nav-bar {
      position: absolute; top: -200px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 500px; transition: top 0.4s;
    }
    #nav-bar.visible { top: 100px; }

    .leaflet-routing-container { display: none !important; }

    /* Desktop/iPad Landscape */
    @media (min-width: 1024px) {
      .sidebar { width: 120px; height: 100%; flex-direction: column !important; }
      .main-wrapper { flex-direction: row; }
      .ui-top { left: 120px; }
      .ui-bottom { display: none; } /* In Desktop sidebar only */
    }
  </style>
</head>
<body>

<div id="start-overlay">
    <button id="init-btn" class="bg-blue-600 px-16 py-8 rounded-[30px] font-black text-2xl uppercase shadow-2xl">
        System Initialisieren
    </button>
</div>

<div class="main-wrapper" id="app">
    <header class="ui-top p-6 flex justify-between items-start">
        <div class="bg-black/60 p-4 rounded-2xl backdrop-blur-md border border-white/10 interactive">
            <h1 class="text-2xl font-black italic text-blue-500">TS <span class="text-white">PRO</span></h1>
            <p id="weather" class="text-[9px] font-bold opacity-60">GEOLOCATION ACTIVE</p>
        </div>
        <div class="bg-black/60 p-4 rounded-2xl backdrop-blur-md border border-white/10 text-center interactive min-w-[120px]">
            <span id="speed" class="text-5xl font-black italic">0</span>
            <span class="text-[10px] block font-bold text-blue-500">km/h</span>
        </div>
    </header>

    <div id="nav-bar" class="bg-slate-900 p-4 rounded-3xl border border-white/20 interactive flex gap-2">
        <input type="text" id="dest-input" placeholder="Ziel..." class="bg-black/40 w-full p-3 rounded-xl outline-none text-white">
        <button onclick="startNav(event)" class="bg-blue-600 px-6 rounded-xl font-bold">GO</button>
    </div>

    <div id="map"></div>

    <footer class="ui-bottom p-6 flex justify-center items-center gap-4">
        <div class="bg-black/60 p-4 rounded-[35px] backdrop-blur-md border border-white/10 flex gap-4 interactive">
            <button onclick="toggleNav(event)" class="action-btn"><i class="fas fa-route text-blue-400 text-2xl"></i></button>
            <button onclick="toggleSatellite(event)" class="action-btn"><i class="fas fa-globe text-slate-400 text-2xl"></i></button>
            <button onclick="handleReport(event, 'police')" class="action-btn"><i class="fas fa-user-shield text-blue-400 text-2xl"></i></button>
            <button onclick="handleReport(event, 'speed')" class="action-btn"><i class="fas fa-camera text-red-500 text-2xl"></i></button>
            <button onclick="handleReport(event, 'accident')" class="action-btn"><i class="fas fa-triangle-exclamation text-orange-400 text-2xl"></i></button>
            <button onclick="event.stopPropagation(); window.location.href='tel:112'" class="action-btn bg-red-600/20"><i class="fas fa-phone text-white text-2xl"></i></button>
        </div>
    </footer>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker, routingControl;
  let currentLayer = 'dark';

  const tiles = {
    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
    sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
  };

  document.getElementById('init-btn').addEventListener('click', () => {
    window.speechSynthesis.speak(new SpeechSynthesisUtterance("System aktiv"));
    document.getElementById('start-overlay').style.display = 'none';
    document.getElementById('app').classList.add('active');
    
    // Karte leicht verz√∂gert laden um Blackscreen zu verhindern
    setTimeout(() => initSystem(), 100);
  });

  window.handleReport = async (e, type) => {
    e.stopPropagation();
    if(!userPos) return;
    await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
    window.speechSynthesis.speak(new SpeechSynthesisUtterance("Meldung erfasst"));
  };

  window.toggleNav = (e) => {
    e.stopPropagation();
    document.getElementById('nav-bar').classList.toggle('visible');
  };

  window.toggleSatellite = (e) => {
    e.stopPropagation();
    map.removeLayer(tiles[currentLayer]);
    currentLayer = (currentLayer === 'dark') ? 'sat' : 'dark';
    tiles[currentLayer].addTo(map);
  };

  window.startNav = async (e) => {
    e.stopPropagation();
    const val = document.getElementById('dest-input').value;
    if(!val || !userPos) return;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`);
    const d = await r.json();
    if(d[0]) {
      const target = L.latLng(d[0].lat, d[0].lon);
      if(routingControl) map.removeControl(routingControl);
      routingControl = L.Routing.control({
        waypoints: [L.latLng(userPos[0], userPos[1]), target],
        lineOptions: { styles: [{ color: '#3b82f6', weight: 10, opacity: 0.8 }] },
        createMarker: () => null
      }).addTo(map);
      document.getElementById('nav-bar').classList.remove('visible');
    }
  };

  function initSystem() {
    navigator.geolocation.watchPosition(p => {
      userPos = [p.coords.latitude, p.coords.longitude];
      document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
      
      if(!map) {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView(userPos, 15);
        tiles[currentLayer].addTo(map);
        userMarker = L.circleMarker(userPos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1, interactive: false }).addTo(map);
        
        onSnapshot(query(collection(db, "reports"), orderBy("time", "desc"), limit(40)), snap => {
          snap.docChanges().forEach(c => {
            if (c.type === "added") {
              const d = c.doc.data();
              const icons = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è' };
              L.marker([d.lat, d.lng], { icon: L.divIcon({ html: `<div class="text-3xl">${icons[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'}) }).addTo(map);
            }
          });
        });
      } else {
        userMarker.setLatLng(userPos);
        if(routingControl) routingControl.spliceWaypoints(0, 1, L.latLng(userPos[0], userPos[1]));
      }
    }, null, { enableHighAccuracy: true });
  }
</script>

</body>
</html>
