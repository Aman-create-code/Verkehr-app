<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet - Zero Scroll Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* Absoluter Scroll-Stopp */
    html, body { 
      position: fixed; 
      overflow: hidden; 
      width: 100%; 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      background: #020617; 
    }

    /* Die Karte f√ºllt den ganzen Hintergrund */
    #map { 
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      z-index: 1;
    }

    /* Header & UI Overlays */
    .ui-layer {
      position: absolute;
      left: 0;
      right: 0;
      z-index: 1000;
      pointer-events: none; /* Klicks gehen durch leere Bereiche zur Karte durch */
    }

    .ui-layer button, .ui-layer input, .ui-layer .panel {
      pointer-events: auto; /* Buttons sind aber klickbar */
    }

    .header-pos { top: 0; padding: 15px; padding-top: env(safe-area-inset-top); }
    .footer-pos { bottom: 0; padding-bottom: env(safe-area-inset-bottom); }

    .glass { 
      background: rgba(15, 23, 42, 0.9); 
      backdrop-filter: blur(20px); 
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .btn-action {
      width: 65px;
      height: 65px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      transition: all 0.2s;
    }
    .btn-action:active { transform: scale(0.8); background: #3b82f6 !important; }

    /* iPad Modus: Buttons an die Seite */
    @media (min-width: 768px) {
      .footer-pos {
        right: 0;
        left: auto;
        bottom: 50%;
        transform: translateY(50%);
        flex-direction: column !important;
        width: 100px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="ui-layer header-pos">
    <div class="panel glass p-4 rounded-[30px] flex justify-between items-center shadow-2xl">
      <div>
        <h1 class="text-xl font-black italic text-blue-500 leading-none">TS PRO</h1>
        <span id="weather" class="text-[9px] font-bold opacity-50 uppercase">Synchronisiere...</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="text-center">
            <span id="speed" class="text-3xl font-black leading-none">0</span>
            <span class="text-[10px] block opacity-50 font-bold uppercase">km/h</span>
        </div>
        <button id="settings-btn" class="bg-white/5 p-3 rounded-2xl"><i class="fas fa-cog"></i></button>
      </div>
    </div>
  </div>

  <div class="ui-layer footer-pos">
    <div class="max-w-md mx-auto w-full px-4 mb-4">
        <div class="panel glass p-2 rounded-2xl flex gap-2">
            <input id="dest" placeholder="Ziel..." class="bg-transparent flex-grow px-3 text-sm outline-none text-white">
            <button id="nav-go" class="bg-blue-600 p-3 rounded-xl"><i class="fas fa-route"></i></button>
        </div>
    </div>
    
    <div class="panel glass p-5 rounded-t-[45px] md:rounded-[40px] flex justify-around items-center gap-2 shadow-2xl">
      <button id="p-btn" class="btn-action bg-blue-600/20 border border-blue-500/30"><i class="fas fa-user-shield text-blue-400 text-2xl"></i></button>
      <button id="s-btn" class="btn-action bg-red-600/20 border border-red-500/30"><i class="fas fa-camera text-red-400 text-2xl"></i></button>
      <button id="a-btn" class="btn-action bg-orange-600/20 border border-orange-500/30"><i class="fas fa-car-burst text-orange-400 text-2xl"></i></button>
      <button id="t-btn" class="btn-action bg-amber-500/20 border border-amber-500/30"><i class="fas fa-traffic text-amber-400 text-2xl"></i></button>
      <button onclick="window.location.href='tel:112'" class="btn-action bg-white/5 border border-white/20"><i class="fas fa-phone text-white text-2xl"></i></button>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 z-[5000] bg-black/90 hidden items-center justify-center p-6">
    <div class="bg-slate-900 border border-white/10 p-8 rounded-[40px] w-full max-w-sm">
      <h2 class="text-2xl font-black mb-6">SETUP</h2>
      <div class="space-y-4">
        <div class="flex justify-between p-4 bg-white/5 rounded-2xl">
          <span>Light Mode</span>
          <input type="checkbox" id="light-toggle" class="w-6 h-6">
        </div>
        <button id="close-modal" class="w-full bg-blue-600 p-4 rounded-2xl font-bold mt-4">SPEICHERN</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker, tiles;

  // INITIALISIERUNG
  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    
    if(!map) {
      map = L.map('map', { zoomControl: false, attributionControl: false }).setView(userPos, 16);
      tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
      userMarker = L.circleMarker(userPos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
      
      onSnapshot(collection(db, "reports"), snap => {
        snap.docChanges().forEach(c => {
          if (c.type === "added") {
            const d = c.doc.data();
            const icons = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è', traffic: 'üöó' };
            L.marker([d.lat, d.lng], {
              icon: L.divIcon({ html: `<div class="text-3xl">${icons[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'})
            }).addTo(map);
          }
        });
      });
      fetchWeather();
    } else {
      userMarker.setLatLng(userPos);
    }
  }, null, { enableHighAccuracy: true });

  async function fetchWeather() {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userPos[0]}&longitude=${userPos[1]}&current_weather=true`);
    const d = await r.json();
    document.getElementById('weather').innerText = `${d.current_weather.temperature}¬∞C ‚Ä¢ ${d.current_weather.windspeed} km/h Wind`;
  }

  // BUTTON LOGIK
  const send = async (type) => {
    if(!userPos) return;
    await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
    const s = new SpeechSynthesisUtterance("Meldung gesendet");
    s.lang = 'de-DE'; window.speechSynthesis.speak(s);
  };

  document.getElementById('p-btn').onclick = () => send('police');
  document.getElementById('s-btn').onclick = () => send('speed');
  document.getElementById('a-btn').onclick = () => send('accident');
  document.getElementById('t-btn').onclick = () => send('traffic');
  
  document.getElementById('settings-btn').onclick = () => document.getElementById('modal').style.display = 'flex';
  document.getElementById('close-modal').onclick = () => document.getElementById('modal').style.display = 'none';

  document.getElementById('light-toggle').onchange = (e) => {
    map.removeLayer(tiles);
    tiles = L.tileLayer(e.target.checked ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
  };
</script>
</body>
</html>
