<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet - iPad Pro Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <style>
    body { background: #020617; color: white; overflow: hidden; transition: 0.3s; height: 100vh; }
    body.light { background: #f1f5f9; color: #0f172a; }
    
    /* iPad / Desktop Optimierung */
    @media (min-width: 768px) {
      .main-container { flex-direction: row !important; }
      .side-controls { width: 120px !important; height: 100% !important; flex-direction: column !important; padding: 20px 10px !important; }
      #map { height: calc(100vh - 100px) !important; margin: 20px !important; flex-grow: 1; }
    }

    #map { height: calc(100vh - 380px); border-radius: 30px; margin: 15px; border: 2px solid rgba(59, 130, 246, 0.2); transition: opacity 0.5s, transform 0.5s; }
    #map.hidden-map { opacity: 0; transform: scale(0.9); pointer-events: none; }
    
    .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
    .light .glass { background: rgba(255, 255, 255, 0.85); border: 1px solid rgba(0,0,0,0.1); }
    
    .menu-panel { display: none; position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
    .active { display: flex; }
    .leaflet-routing-container { display: none; }
  </style>
</head>
<body class="flex flex-col">

<div id="boot" onclick="startApp()" class="fixed inset-0 z-[10000] bg-gradient-to-br from-blue-900 to-black flex flex-col items-center justify-center text-center p-6 cursor-pointer">
  <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center animate-bounce mb-6 shadow-[0_0_50px_rgba(37,99,235,0.5)]">
    <i class="fas fa-power-off text-4xl"></i>
  </div>
  <h2 class="text-3xl font-black italic tracking-tighter mb-2">TRAFFIC SWEET</h2>
  <p class="text-blue-400 font-bold animate-pulse">SYSTEM INITIALISIEREN</p>
</div>

<header class="p-4 lg:p-6 flex justify-between items-center z-[500] glass m-4 rounded-3xl">
  <div class="flex items-center gap-4">
    <button onclick="toggleMap()" class="bg-slate-800 p-3 rounded-2xl hover:bg-slate-700 transition">
        <i id="map-icon" class="fas fa-eye-slash"></i>
    </button>
    <div>
      <h1 class="text-xl lg:text-3xl font-black italic text-blue-500 tracking-tighter">TS PRO</h1>
      <div id="weather" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">Wetter laden...</div>
    </div>
  </div>
  
  <div class="flex items-center gap-4">
    <div class="bg-blue-600 px-6 py-2 rounded-2xl shadow-lg shadow-blue-500/20 text-center">
        <span id="speed" class="text-2xl lg:text-4xl font-black">0</span> 
        <span class="text-[10px] block font-bold -mt-1 opacity-80 uppercase">km/h</span>
    </div>
    <button onclick="toggleMenu()" class="text-2xl"><i class="fas fa-sliders"></i></button>
  </div>
</header>

<main class="main-container flex flex-col flex-grow relative">
    <div class="px-4 mb-2 max-w-2xl mx-auto w-full">
        <div class="flex gap-2 bg-slate-900/80 p-3 rounded-2xl border border-white/10 glass shadow-2xl">
            <input id="target" placeholder="Zielort..." class="flex-grow bg-transparent outline-none px-2 text-white">
            <button onclick="navNow()" class="bg-blue-600 w-12 h-10 rounded-xl flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div id="eta" class="hidden flex justify-between px-3 mt-2 text-xs font-black text-blue-400">
            <span id="eta-dist"></span>
            <span id="eta-time"></span>
        </div>
    </div>

    <div id="map"></div>

    <footer class="side-controls glass p-5 rounded-t-[40px] lg:rounded-[40px] flex justify-around items-center lg:m-4">
      <button onclick="report('police')" class="group flex flex-col items-center"><div class="bg-blue-600/20 p-5 rounded-3xl border border-blue-500/30 group-active:scale-90 transition"><i class="fas fa-shield-halved text-blue-400 text-xl"></i></div></button>
      <button onclick="report('speed')" class="group flex flex-col items-center"><div class="bg-red-600/20 p-5 rounded-3xl border border-red-500/30 group-active:scale-90 transition"><i class="fas fa-camera text-red-400 text-xl"></i></div></button>
      <button onclick="report('accident')" class="group flex flex-col items-center"><div class="bg-orange-600/20 p-5 rounded-3xl border border-orange-500/30 group-active:scale-90 transition"><i class="fas fa-triangle-exclamation text-orange-400 text-xl"></i></div></button>
      <button onclick="report('traffic')" class="group flex flex-col items-center"><div class="bg-amber-500/20 p-5 rounded-3xl border border-amber-500/30 group-active:scale-90 transition"><i class="fas fa-clock text-amber-400 text-xl"></i></div></button>
    </footer>
</main>

<div id="menu" class="menu-panel">
  <div class="bg-slate-900 border border-slate-700 p-8 rounded-[50px] w-[90%] max-w-md">
    <h2 class="text-3xl font-black mb-8 italic">SETUP</h2>
    <div class="space-y-6">
      <div class="flex justify-between p-4 bg-white/5 rounded-2xl"><span>Hell-Modus</span><input type="checkbox" id="t-light" onchange="upd()" class="w-6 h-6"></div>
      <div class="flex justify-between p-4 bg-white/5 rounded-2xl"><span>Sprach-Warnung</span><input type="checkbox" id="t-voice" checked class="w-6 h-6"></div>
      <div class="flex justify-between p-4 bg-white/5 rounded-2xl"><span>Satellit</span><input type="checkbox" id="t-sat" onchange="upd()" class="w-6 h-6"></div>
      <button onclick="window.location.href='tel:112'" class="w-full bg-red-600 p-4 rounded-2xl font-black uppercase text-center"><i class="fas fa-phone mr-2"></i> SOS NOTRUF</button>
    </div>
    <button onclick="toggleMenu()" class="mt-8 w-full p-4 border border-white/20 rounded-2xl font-bold">ZUR√úCK</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    storageBucket: "verkehr-725d5.firebasestorage.app",
    messagingSenderId: "22824354784",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let map, userPos, userMarker, routing, tiles;
  let markers = {};

  window.startApp = () => {
    document.getElementById('boot').classList.add('hidden');
    say("System online. Gute Fahrt.");
    init();
  };

  window.toggleMenu = () => document.getElementById('menu').classList.toggle('active');
  
  window.toggleMap = () => {
    const m = document.getElementById('map');
    const i = document.getElementById('map-icon');
    m.classList.toggle('hidden-map');
    i.classList.toggle('fa-eye');
    i.classList.toggle('fa-eye-slash');
  };

  window.upd = () => {
    const isL = document.getElementById('t-light').checked;
    const isS = document.getElementById('t-sat').checked;
    document.body.classList.toggle('light', isL);
    if(map){
        map.removeLayer(tiles);
        let url = isL ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        if(isS) url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
        tiles = L.tileLayer(url).addTo(map);
    }
  };

  function say(t) {
    if(!document.getElementById('t-voice').checked) return;
    const s = new SpeechSynthesisUtterance(t);
    s.lang = 'de-DE';
    window.speechSynthesis.speak(s);
  }

  function init() {
    navigator.geolocation.watchPosition(p => {
      userPos = [p.coords.latitude, p.coords.longitude];
      document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
      
      if(!map) {
        map = L.map('map', { zoomControl: false }).setView(userPos, 16);
        tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        userMarker = L.circleMarker(userPos, { radius: 12, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
        sync();
        getWeather(userPos);
      } else {
        userMarker.setLatLng(userPos);
      }
    }, null, { enableHighAccuracy: true });
  }

  async function getWeather(pos) {
    try {
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos[0]}&longitude=${pos[1]}&current_weather=true`);
        const d = await r.json();
        document.getElementById('weather').innerText = `${d.current_weather.temperature}¬∞C - ${d.current_weather.windspeed} km/h Wind`;
    } catch(e) {}
  }

  window.report = async (type) => {
    if(!userPos) return;
    await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
    say(type + " wurde erfasst.");
  };

  function sync() {
    onSnapshot(collection(db, "reports"), snap => {
      snap.docChanges().forEach(c => {
        const d = c.doc.data();
        if(Date.now() - d.time < 3600000) {
            const icons = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è', traffic: 'üöó' };
            L.marker([d.lat, d.lng], {
              icon: L.divIcon({ html: `<div class="text-3xl">${icons[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'})
            }).addTo(map);
        }
      });
    });
  }

  window.navNow = async () => {
    const q = document.getElementById('target').value;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await r.json();
    if(data[0]) {
      if(routing) map.removeControl(routing);
      routing = L.Routing.control({
        waypoints: [L.latLng(userPos[0], userPos[1]), L.latLng(data[0].lat, data[0].lon)],
        createMarker: () => null,
        lineOptions: { styles: [{ color: '#3b82f6', weight: 8, opacity: 0.8 }] }
      }).on('routesfound', e => {
        const s = e.routes[0].summary;
        document.getElementById('eta').classList.remove('hidden');
        document.getElementById('eta-dist').innerText = (s.totalDistance/1000).toFixed(1) + " KM";
        document.getElementById('eta-time').innerText = Math.round(s.totalTime/60) + " MIN";
        say("Ziel gefunden. Strecke: " + (s.totalDistance/1000).toFixed(1) + " Kilometer.");
      }).addTo(map);
    }
  };
</script>
</body>
</html>
