<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TS PRO - Live Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { background: #020617; color: white; font-family: sans-serif; overflow: hidden; height: 100vh; width: 100vw; margin: 0; position: fixed; }
    #map { position: absolute; inset: 0; z-index: 1; }
    .ui-wrapper { position: absolute; inset: 0; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
    .clickable { pointer-events: auto; }
    .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    
    /* Popup Style */
    .leaflet-popup-content-wrapper { background: #0f172a; color: white; border: 1px solid #3b82f6; border-radius: 15px; }
    .leaflet-popup-tip { background: #3b82f6; }

    #start-screen { position: fixed; inset: 0; z-index: 10000; background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #start-screen.hidden { display: none; }
    #toast { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%) translateY(150px); transition: 0.4s; z-index: 5000; pointer-events: none; }
    #toast.visible { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<div id="start-screen">
    <h1 class="text-6xl font-black italic text-blue-500 mb-2 tracking-tighter">TS PRO</h1>
    <p class="text-blue-300 font-bold mb-8 uppercase text-xs tracking-[0.3em]">Live Verification Mode</p>
    <button id="start-btn" class="clickable bg-blue-600 text-white font-bold py-5 px-14 rounded-full text-2xl shadow-2xl btn-active">START</button>
</div>

<div id="map"></div>

<div class="ui-wrapper">
    <header class="p-4 flex justify-between items-center w-full">
        <div class="glass px-5 py-2 rounded-full border border-blue-500/30 clickable">
            <h1 class="text-xl font-black italic text-blue-500 tracking-tighter">TS PRO</h1>
        </div>
        <div class="glass px-4 py-2 rounded-2xl border border-blue-500/50 clickable">
            <span id="speed" class="text-2xl font-black text-white">0</span> <small class="text-xs text-blue-400">km/h</small>
        </div>
    </header>

    <footer class="glass p-6 rounded-t-[45px] grid grid-cols-4 gap-3 clickable bg-slate-900/95 border-t border-blue-500/20">
        <button id="rep-police" class="bg-blue-900/40 p-4 rounded-3xl border border-blue-500/30 flex flex-col items-center justify-center gap-1">
            <i class="fas fa-user-shield text-blue-400 text-2xl"></i>
            <span class="text-[9px] font-black text-blue-200">Police</span>
        </button>
        <button id="rep-speed" class="bg-red-900/40 p-4 rounded-3xl border border-red-500/30 flex flex-col items-center justify-center gap-1">
            <i class="fas fa-camera text-red-400 text-2xl"></i>
            <span class="text-[9px] font-black text-red-200">Blitzer</span>
        </button>
        <button id="rep-accident" class="bg-orange-900/40 p-4 rounded-3xl border border-orange-500/30 flex flex-col items-center justify-center gap-1">
            <i class="fas fa-car-burst text-orange-400 text-2xl"></i>
            <span class="text-[9px] font-black text-orange-200">Unfall</span>
        </button>
        <button id="rep-traffic" class="bg-amber-900/40 p-4 rounded-3xl border border-amber-500/30 flex flex-col items-center justify-center gap-1">
            <i class="fas fa-traffic-light text-amber-400 text-2xl"></i>
            <span class="text-[9px] font-black text-amber-200">Stau</span>
        </button>
    </footer>
</div>

<div id="toast" class="glass border border-blue-500 px-6 py-3 rounded-full shadow-2xl bg-slate-900">
  <span id="toast-msg" class="font-bold uppercase text-xs text-blue-400">Meldung gesendet!</span>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    storageBucket: "verkehr-725d5.firebasestorage.app",
    messagingSenderId: "22824354784",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker;
  let activeMarkers = {}; // Speichert Marker-Objekte, um sie l√∂schen zu k√∂nnen

  document.getElementById('start-btn').onclick = () => {
    document.getElementById('start-screen').classList.add('hidden');
    if(!map) initMap([51.16, 10.45]);
  };

  function initMap(pos) {
    map = L.map('map', { zoomControl: false, attributionControl: false }).setView(pos, 15);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    userMarker = L.circleMarker(pos, { radius: 9, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);

    // Echtzeit-√úberwachung der Firebase
    onSnapshot(collection(db, "reports"), (snap) => {
        const now = Date.now();
        snap.docChanges().forEach(change => {
            const data = change.doc.data();
            const id = change.doc.id;
            const timestamp = data.createdAt?.toMillis() || now;

            if (change.type === "removed") {
                removeMarker(id);
            } else {
                // Nur anzeigen, wenn j√ºnger als 5 Minuten (300.000 ms)
                if (now - timestamp < 300000) {
                    updateOrAddMarker(id, data);
                } else {
                    removeMarker(id);
                }
            }
        });
    });

    // Alle 30 Sekunden die Karte pr√ºfen, um abgelaufene Marker lokal zu l√∂schen
    setInterval(checkExpirations, 30000);
  }

  function updateOrAddMarker(id, data) {
    const emoji = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è', traffic: 'üöó' };
    const label = { police: 'Polizei', speed: 'Blitzer', accident: 'Unfall', traffic: 'Stau' };
    
    // Falls Marker existiert, erst entfernen
    removeMarker(id);

    const marker = L.marker([data.lat, data.lng], {
        icon: L.divIcon({ html: `<div class="text-3xl">${emoji[data.type]}</div>`, className: 'bg-transparent'})
    }).addTo(map);

    // Popup mit "Noch da?" Button
    const popupContent = `
        <div class="text-center p-2">
            <div class="font-bold text-lg mb-1">${label[data.type]}</div>
            <div class="text-[10px] text-gray-400 mb-3">Gesehen vor wenigen Minuten</div>
            <button onclick="window.verifyReport('${id}')" class="bg-blue-600 text-white text-[10px] font-bold py-2 px-4 rounded-full uppercase">Noch da?</button>
        </div>
    `;
    marker.bindPopup(popupContent);
    activeMarkers[id] = { marker, time: data.createdAt?.toMillis() || Date.now() };
  }

  function removeMarker(id) {
    if (activeMarkers[id]) {
        map.removeLayer(activeMarkers[id].marker);
        delete activeMarkers[id];
    }
  }

  function checkExpirations() {
    const now = Date.now();
    for (let id in activeMarkers) {
        if (now - activeMarkers[id].time > 300000) {
            removeMarker(id);
        }
    }
  }

  // Diese Funktion wird aufgerufen, wenn jemand auf "Noch da?" klickt
  window.verifyReport = async (id) => {
    try {
        const reportRef = doc(db, "reports", id);
        await updateDoc(reportRef, {
            createdAt: serverTimestamp() // Setzt die Zeit auf "jetzt" zur√ºck -> neue 5 Minuten
        });
        showMsg("Zeit verl√§ngert!");
        map.closePopup();
    } catch (e) {
        showMsg("Fehler!");
    }
  };

  const send = async (type, name) => {
    if(!userPos) return showMsg("Kein GPS!");
    try {
        await addDoc(collection(db, "reports"), {
            type, lat: userPos[0], lng: userPos[1], createdAt: serverTimestamp()
        });
        showMsg(name + " gemeldet!");
    } catch (e) { showMsg("Fehler!"); }
  };

  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    if(map) userMarker.setLatLng(userPos);
  }, null, { enableHighAccuracy: true });

  function showMsg(txt) {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').innerText = txt;
    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 3000);
  }

  document.getElementById('rep-police').onclick = () => send('police', 'Polizei');
  document.getElementById('rep-speed').onclick = () => send('speed', 'Blitzer');
  document.getElementById('rep-accident').onclick = () => send('accident', 'Unfall');
  document.getElementById('rep-traffic').onclick = () => send('traffic', 'Stau');
</script>
</body>
</html>
