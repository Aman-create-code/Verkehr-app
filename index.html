<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet Ultimate AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --accent: #3b82f6; }
    body { background: #020617; color: white; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; transition: 0.4s; }
    
    /* Responsive Layout Logik */
    .app-container { display: flex; flex-direction: column; height: 100vh; }
    
    @media (min-width: 768px) { /* iPad / Tablet Modus */
      .app-container { flex-direction: row; }
      .side-nav { width: 100px; height: 100vh; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); border-top: none; }
      #map { flex-grow: 1; height: 95vh !important; margin: 10px; }
    }

    /* Karte Styling */
    #map { height: calc(100vh - 350px); border-radius: 25px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid rgba(255,255,255,0.05); }
    
    /* Neon & Light Modes */
    body.light { background: #f8fafc; color: #0f172a; --accent: #2563eb; }
    body.neon { background: #000; color: #0ff; --accent: #0ff; }
    .neon #map { border-color: #0ff; box-shadow: 0 0 15px #0ff3; }

    /* Animationen */
    .pulse-danger { animation: danger-blink 1s infinite; }
    @keyframes danger-blink { 0% { box-shadow: inset 0 0 0px red; } 50% { box-shadow: inset 0 0 30px red; } 100% { box-shadow: inset 0 0 0px red; } }
    
    .btn-click:active { transform: scale(0.85); background: var(--accent) !important; color: white !important; }
    
    .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); }
    .light .glass { background: rgba(255, 255, 255, 0.8); }
    
    #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); transition: 0.5s; z-index: 9999; }
    #toast.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body class="dark">

<div id="toast" class="glass border border-blue-500 px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4">
    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
    <span id="toast-text" class="font-black uppercase tracking-widest text-sm">System Bereit</span>
</div>

<div class="app-container">
    <header class="p-6 flex justify-between items-center z-50">
        <div>
            <h1 class="text-3xl font-black italic tracking-tighter" style="color: var(--accent)">TS ULTIMATE</h1>
            <p id="weather-info" class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Lade Wetter...</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right glass p-3 rounded-2xl border border-white/10">
                <span id="speed" class="text-3xl font-black">0</span>
                <span class="text-[10px] block opacity-50 -mt-1 font-bold">KM/H</span>
            </div>
            <button id="btn-settings" class="text-2xl hover:rotate-90 transition-transform"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="map" class="shadow-2xl"></div>

    <footer class="side-nav glass p-6 flex justify-around items-center border-t border-white/5 rounded-t-[40px] lg:rounded-none">
        <button id="rep-police" class="btn-click bg-blue-600/10 p-5 rounded-3xl border border-blue-500/20"><i class="fas fa-user-shield text-blue-400 text-2xl"></i></button>
        <button id="rep-speed" class="btn-click bg-red-600/10 p-5 rounded-3xl border border-red-500/20"><i class="fas fa-camera text-red-400 text-2xl"></i></button>
        <button id="rep-accident" class="btn-click bg-orange-600/10 p-5 rounded-3xl border border-orange-500/20"><i class="fas fa-car-burst text-orange-400 text-2xl"></i></button>
        <button id="rep-sos" class="btn-click bg-white/5 p-5 rounded-3xl border border-white/10"><i class="fas fa-phone-alt text-white text-2xl"></i></button>
    </footer>
</div>

<div id="settings-modal" class="fixed inset-0 z-[10000] bg-black/80 backdrop-blur-md hidden items-center justify-center p-6">
    <div class="bg-slate-900 border border-white/10 p-8 rounded-[40px] w-full max-w-sm">
        <h2 class="text-3xl font-black mb-8 italic">KONFIGURATION</h2>
        <div class="space-y-6">
            <div class="flex justify-between items-center"><span>Design</span>
                <select id="theme-select" class="bg-white/5 p-2 rounded-xl outline-none">
                    <option value="dark">Dark Mode</option>
                    <option value="light">Light Mode</option>
                    <option value="neon">Neon Blue</option>
                </select>
            </div>
            <div class="flex justify-between items-center"><span>Sprach-Feedback</span><input type="checkbox" id="voice-check" checked class="w-6 h-6"></div>
            <div class="flex justify-between items-center"><span>Karte verbergen</span><input type="checkbox" id="hide-map" class="w-6 h-6"></div>
        </div>
        <button id="close-settings" class="mt-10 w-full bg-blue-600 p-5 rounded-3xl font-black uppercase tracking-widest">Speichern</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker, tiles;

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function playPing() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
  }

  function showToast(m) {
    document.getElementById('toast-text').innerText = m;
    const t = document.getElementById('toast');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    
    if(!map) {
      map = L.map('map', { zoomControl: false }).setView(userPos, 16);
      tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
      userMarker = L.circleMarker(userPos, { radius: 12, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
      
      onSnapshot(collection(db, "reports"), snap => {
        snap.docChanges().forEach(c => {
          if (c.type === "added") {
            const d = c.doc.data();
            const emoji = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è' };
            L.marker([d.lat, d.lng], { icon: L.divIcon({ html: `<div class="text-3xl">${emoji[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'}) }).addTo(map);
            checkProximity(d);
          }
        });
      });
      getWeather(userPos);
    } else {
      userMarker.setLatLng(userPos);
    }
  }, null, { enableHighAccuracy: true });

  async function getWeather(pos) {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos[0]}&longitude=${pos[1]}&current_weather=true`);
    const d = await r.json();
    document.getElementById('weather-info').innerText = `${d.current_weather.temperature}¬∞C ‚Ä¢ ${d.current_weather.windspeed} km/h Wind`;
  }

  function checkProximity(report) {
    if(!userPos) return;
    const dist = map.distance(userPos, [report.lat, report.lng]);
    if(dist < 500) {
        document.body.classList.add('pulse-danger');
        if(document.getElementById('voice-check').checked) {
            const s = new SpeechSynthesisUtterance("Achtung, Gefahr in f√ºnfhundert Metern.");
            s.lang = 'de-DE'; window.speechSynthesis.speak(s);
        }
        setTimeout(() => document.body.classList.remove('pulse-danger'), 5000);
    }
  }

  const send = async (type, label) => {
    playPing();
    await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
    showToast(label + " GEMELDET");
  };

  document.getElementById('rep-police').onclick = () => send('police', 'POLIZEI');
  document.getElementById('rep-speed').onclick = () => send('speed', 'BLITZER');
  document.getElementById('rep-accident').onclick = () => send('accident', 'UNFALL');
  document.getElementById('rep-sos').onclick = () => window.location.href = "tel:112";

  document.getElementById('btn-settings').onclick = () => document.getElementById('settings-modal').style.display = 'flex';
  document.getElementById('close-settings').onclick = () => document.getElementById('settings-modal').style.display = 'none';

  document.getElementById('theme-select').onchange = (e) => {
    const t = e.target.value;
    document.body.className = t;
    map.removeLayer(tiles);
    let url = t === 'light' ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    tiles = L.tileLayer(url).addTo(map);
  };

  document.getElementById('hide-map').onchange = (e) => {
    document.getElementById('map').style.opacity = e.target.checked ? '0' : '1';
    document.getElementById('map').style.transform = e.target.checked ? 'scale(0.8)' : 'scale(1)';
  };
</script>
</body>
</html>
