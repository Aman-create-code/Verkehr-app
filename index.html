<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TS PRO - Midnight Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --p-blue: #3b82f6; --s-red: #ef4444; --bg: #020617; }
    body, html { height: 100svh; width: 100vw; margin: 0; overflow: hidden; background: #000; color: white; font-family: 'Inter', sans-serif; }

    /* Midnight UI Style - Kein Glas mehr */
    .midnight-panel {
      background: #0f172a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }

    /* Layout Grid */
    .app-grid { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    #map { width: 100%; height: 100%; z-index: 1; filter: grayscale(0.5) brightness(0.7) invert(0.05); }

    .action-btn {
      width: 75px; height: 75px; border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .action-btn:active { transform: scale(0.9); background: #334155; }

    /* Nav Search Bar */
    #nav-bar {
      position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 600px; z-index: 2000; transition: top 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #nav-bar.visible { top: 20px; }

    /* iPad / Landscape Fix */
    @media (min-width: 1024px) {
      .app-grid { grid-template-columns: 140px 1fr; grid-template-rows: 90px 1fr; }
      .sidebar { grid-row: 1/3; flex-direction: column !important; border-radius: 0 !important; margin: 0 !important; height: 100%; }
      header { grid-column: 2; border-bottom: 1px solid rgba(255,255,255,0.1); }
      #map { grid-column: 2; }
    }
  </style>
</head>
<body>

<div id="nav-bar" class="midnight-panel p-3 rounded-3xl flex gap-3 items-center">
  <i class="fas fa-search ml-3 text-slate-400"></i>
  <input type="text" id="dest-input" placeholder="Zielort eingeben..." 
         class="bg-transparent w-full p-3 outline-none text-white font-medium">
  <button onclick="startNav()" class="bg-blue-600 px-8 py-3 rounded-2xl font-black uppercase text-xs">Start</button>
</div>

<div class="app-grid">
  <header class="p-6 flex justify-between items-center z-50 bg-[#020617]">
    <div>
      <h1 class="text-3xl font-black italic tracking-tighter text-blue-500">TS <span class="text-white">PRO</span></h1>
      <p id="weather" class="text-[10px] font-bold opacity-40 uppercase tracking-widest">Midnight Core Active</p>
    </div>
    
    <div class="midnight-panel px-8 py-3 rounded-2xl flex items-center gap-6">
      <div class="text-center">
        <span id="speed" class="text-4xl font-black text-white">0</span>
        <span class="text-[10px] block font-bold text-blue-500 tracking-widest uppercase">km/h</span>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <footer class="sidebar p-6 flex justify-around items-center gap-4 z-50 bg-[#020617] border-t border-white/10">
    <button onclick="toggleNav()" class="action-btn border-blue-500/40">
        <i class="fas fa-location-arrow text-blue-500 text-3xl"></i>
    </button>
    <button onclick="rep('police')" class="action-btn"><i class="fas fa-user-shield text-blue-400 text-3xl"></i></button>
    <button onclick="rep('speed')" class="action-btn"><i class="fas fa-camera text-red-500 text-3xl"></i></button>
    <button onclick="rep('accident')" class="action-btn"><i class="fas fa-car-burst text-orange-400 text-3xl"></i></button>
    <button onclick="window.location.href='tel:112'" class="action-btn bg-red-600/10 border-red-500/20">
        <i class="fas fa-phone text-white text-3xl"></i>
    </button>
  </footer>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker, routeLine;

  window.toggleNav = () => document.getElementById('nav-bar').classList.toggle('visible');

  window.startNav = async () => {
    const query = document.getElementById('dest-input').value;
    if(!query || !userPos) return;

    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
    const data = await res.json();

    if(data[0]) {
      const target = [data[0].lat, data[0].lon];
      if(routeLine) map.removeLayer(routeLine);
      
      routeLine = L.polyline([userPos, target], {
        color: '#3b82f6', weight: 10, opacity: 0.9, lineCap: 'round', shadowBlur: 10, shadowColor: '#3b82f6'
      }).addTo(map);

      map.fitBounds(routeLine.getBounds(), { padding: [100, 100] });
      
      const utter = new SpeechSynthesisUtterance(`Route nach ${query} berechnet.`);
      utter.lang = 'de-DE'; window.speechSynthesis.speak(utter);
      
      document.getElementById('nav-bar').classList.remove('visible');
    }
  };

  window.rep = async (type) => {
    if(!userPos) return;
    await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
    window.speechSynthesis.speak(new SpeechSynthesisUtterance("Meldung registriert"));
  };

  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    
    if(!map) {
      map = L.map('map', { zoomControl: false, attributionControl: false }).setView(userPos, 16);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
      userMarker = L.circleMarker(userPos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
      
      onSnapshot(collection(db, "reports"), snap => {
        snap.docChanges().forEach(c => {
          if (c.type === "added") {
            const d = c.doc.data();
            const icons = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è' };
            L.marker([d.lat, d.lng], {
              icon: L.divIcon({ html: `<div class="text-3xl">${icons[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'})
            }).addTo(map);
          }
        });
      });
      fetchWeather();
    } else {
      userMarker.setLatLng(userPos);
      if(routeLine) routeLine.setLatLngs([userPos, routeLine.getLatLngs()[1]]);
    }
  }, null, { enableHighAccuracy: true });

  async function fetchWeather() {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userPos[0]}&longitude=${userPos[1]}&current_weather=true`);
    const d = await r.json();
    document.getElementById('weather').innerText = `${d.current_weather.temperature}¬∞C ‚Ä¢ System Stable`;
  }
</script>

</body>
</html>
