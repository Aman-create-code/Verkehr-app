<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TS PRO - Liquid Glass Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.15); }
    body, html { height: 100svh; width: 100vw; margin: 0; overflow: hidden; background: #000; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica; }

    /* Apple-Style Glass Morphism */
    .apple-glass {
      background: rgba(20, 20, 25, 0.7);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 1px solid var(--border);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
    }

    /* Layout */
    .app-grid { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    #map { width: 100%; height: 100%; z-index: 1; filter: brightness(0.7) contrast(1.2); }

    /* Buttons */
    .glass-btn {
      width: 70px; height: 70px;
      border-radius: 22px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
    }
    .glass-btn:active { transform: scale(0.9) opacity(0.7); }
    
    /* iPad / Landscape Fix */
    @media (min-width: 1024px) {
      .app-grid { grid-template-columns: 120px 1fr; grid-template-rows: 80px 1fr; }
      .sidebar { grid-row: 1/3; flex-direction: column !important; justify-content: center !important; gap: 2rem !important; }
      header { grid-column: 2; border-bottom: none !important; }
      #map { grid-column: 2; border-radius: 40px 0 0 0; }
    }

    /* Speedo Glanz */
    .speed-glow { text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>

<div class="app-grid">
  <header class="p-4 flex justify-between items-center z-50">
    <div class="pl-2">
      <h1 class="text-2xl font-bold tracking-tight">TS <span class="text-blue-500">PRO</span></h1>
      <p id="weather" class="text-[10px] opacity-40 font-medium">Apple Weather Sync...</p>
    </div>
    
    <div class="apple-glass px-6 py-2 rounded-3xl flex items-center gap-4">
      <div class="text-center">
        <span id="speed" class="text-4xl font-black speed-glow">0</span>
        <span class="text-[9px] block opacity-40 font-bold tracking-widest">KM/H</span>
      </div>
      <div class="w-[1px] h-8 bg-white/10"></div>
      <button onclick="openConfig()" class="text-xl opacity-60"><i class="fas fa-ellipsis-v"></i></button>
    </div>
  </header>

  <div id="map"></div>

  <footer class="sidebar p-6 flex justify-around items-center gap-2 z-50 apple-glass m-4 rounded-[35px]">
    <button onclick="uiAction('police')" class="glass-btn hover:bg-blue-500/20"><i class="fas fa-shield-alt text-blue-400 text-2xl"></i></button>
    <button onclick="uiAction('speed')" class="glass-btn hover:bg-red-500/20"><i class="fas fa-camera-retro text-red-500 text-2xl"></i></button>
    <button onclick="uiAction('accident')" class="glass-btn hover:bg-orange-500/20"><i class="fas fa-exclamation-triangle text-orange-400 text-2xl"></i></button>
    <button onclick="window.location.href='tel:112'" class="glass-btn bg-red-600/10 border-red-500/20"><i class="fas fa-phone-alt text-white text-2xl"></i></button>
  </footer>
</div>

<div id="config-ui" class="fixed inset-0 z-[1000] hidden items-center justify-center p-6 backdrop-blur-3xl">
    <div class="apple-glass p-10 rounded-[45px] w-full max-w-sm border-white/20">
        <h2 class="text-3xl font-bold mb-8">Settings</h2>
        <div class="space-y-6">
            <div class="flex justify-between items-center p-4 bg-white/5 rounded-2xl">
                <span>Map Mirror (HUD)</span>
                <input type="checkbox" id="hud-mode" onchange="document.body.style.transform = this.checked ? 'scaleX(-1)' : 'none'" class="w-6 h-6">
            </div>
            <button onclick="location.reload()" class="w-full p-4 bg-blue-600 rounded-2xl font-bold">Refresh Connection</button>
        </div>
        <button onclick="openConfig()" class="mt-8 w-full text-center opacity-40">Dismiss</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker;

  window.uiAction = async (type) => {
    if(!userPos) return;
    try {
      await addDoc(collection(db, "reports"), { type, lat: userPos[0], lng: userPos[1], time: Date.now() });
      window.speechSynthesis.speak(new SpeechSynthesisUtterance("Report sent"));
    } catch(e) { console.error(e); }
  };

  window.openConfig = () => {
    const el = document.getElementById('config-ui');
    el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
  };

  navigator.geolocation.watchPosition(p => {
    userPos = [p.coords.latitude, p.coords.longitude];
    document.getElementById('speed').innerText = Math.round((p.coords.speed || 0) * 3.6);
    
    if(!map) {
      map = L.map('map', { zoomControl: false, attributionControl: false }).setView(userPos, 16);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
      userMarker = L.circleMarker(userPos, { radius: 10, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
      
      const q = query(collection(db, "reports"), orderBy("time", "desc"), limit(25));
      onSnapshot(q, snap => {
        snap.docChanges().forEach(c => {
          if (c.type === "added") {
            const d = c.doc.data();
            const icons = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è' };
            L.marker([d.lat, d.lng], {
              icon: L.divIcon({ html: `<div class="text-3xl drop-shadow-lg">${icons[d.type] || '‚ùó'}</div>`, className: 'bg-transparent'})
            }).addTo(map);
          }
        });
      });
      fetchWeather();
    } else {
      userMarker.setLatLng(userPos);
    }
  }, null, { enableHighAccuracy: true });

  async function fetchWeather() {
    const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userPos[0]}&longitude=${userPos[1]}&current_weather=true`);
    const d = await r.json();
    document.getElementById('weather').innerText = `${d.current_weather.temperature}¬∞C ‚Ä¢ ${d.current_weather.windspeed} KM/H WIND`;
  }
</script>

</body>
</html>
