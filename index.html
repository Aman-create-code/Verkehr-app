<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Traffic Sweet Pro - Bugfix v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --blue: #3b82f6; --red: #ef4444; }
    body { background: #020617; color: white; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
    
    /* Responsive Layout */
    .app-grid { display: grid; grid-template-rows: auto 1fr auto; height: 100vh; }
    @media (min-width: 1024px) {
      .app-grid { grid-template-columns: 120px 1fr; grid-template-rows: auto 1fr; }
      .side-nav { grid-row: 1 / 3; flex-direction: column !important; border-right: 1px solid rgba(255,255,255,0.1); }
      header { grid-column: 2; }
    }

    #map { height: 100%; width: 100%; border-radius: 0; transition: all 0.4s ease; z-index: 1; }
    .map-container { position: relative; overflow: hidden; border-radius: 30px; margin: 10px; border: 1px solid rgba(255,255,255,0.1); }

    /* UI Elements */
    .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
    .btn-report { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .btn-report:active { transform: scale(0.8) rotate(5deg); background: var(--blue) !important; }
    
    /* Animationen */
    .marker-anim { animation: marker-drop 0.5s ease-out; }
    @keyframes marker-drop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    #speedo.warning { color: var(--red); text-shadow: 0 0 15px var(--red); animation: shake 0.2s infinite; }
    @keyframes shake { 0% { transform: translate(0,0); } 50% { transform: translate(2px,0); } 100% { transform: translate(0,0); } }
  </style>
</head>
<body>

<div class="app-grid">
    <header class="p-4 flex justify-between items-center z-50">
        <div>
            <h1 class="text-2xl font-black tracking-tighter italic text-blue-500">TS PRO <span class="text-white">v4</span></h1>
            <p id="status" class="text-[9px] font-bold text-green-500 uppercase tracking-widest"><i class="fas fa-circle animate-pulse"></i> Live Sync</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="speedo" class="glass px-5 py-2 rounded-2xl border border-white/10 text-center">
                <span id="speed-val" class="text-3xl font-black">0</span>
                <span class="text-[10px] block opacity-50 font-bold -mt-1 uppercase">km/h</span>
            </div>
            <button onclick="toggleSettings()" class="text-xl p-2 bg-white/5 rounded-full"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div class="map-container shadow-2xl">
        <div id="map"></div>
        <div id="danger-alert" class="hidden absolute top-5 left-1/2 -translate-x-1/2 glass border border-red-500 px-6 py-2 rounded-full z-[1000] animate-bounce">
            <span class="text-red-500 font-black text-xs uppercase">‚ö†Ô∏è Gefahr in der N√§he!</span>
        </div>
    </div>

    <footer class="side-nav glass p-4 lg:p-8 flex justify-around items-center border-t border-white/10 lg:border-t-0">
        <button id="p-btn" class="btn-report bg-blue-600/20 p-5 rounded-3xl border border-blue-500/30"><i class="fas fa-user-shield text-blue-400 text-2xl"></i></button>
        <button id="s-btn" class="btn-report bg-red-600/20 p-5 rounded-3xl border border-red-500/30"><i class="fas fa-camera text-red-400 text-2xl"></i></button>
        <button id="a-btn" class="btn-report bg-orange-600/20 p-5 rounded-3xl border border-orange-500/30"><i class="fas fa-car-burst text-orange-400 text-2xl"></i></button>
        <button id="t-btn" class="btn-report bg-amber-500/20 p-5 rounded-3xl border border-amber-500/30"><i class="fas fa-traffic-light text-amber-400 text-2xl"></i></button>
    </footer>
</div>

<div id="settings" class="fixed inset-0 z-[9999] bg-black/90 hidden items-center justify-center p-6 backdrop-blur-md">
    <div class="bg-slate-900 p-8 rounded-[40px] w-full max-w-sm border border-white/10">
        <h2 class="text-3xl font-black mb-6">KONFIG</h2>
        <div class="space-y-6">
            <div class="flex justify-between items-center"><span>Light Mode</span><input type="checkbox" id="light-toggle" onchange="updTheme()" class="w-6 h-6"></div>
            <div class="flex justify-between items-center"><span>3D-Rotation</span><input type="checkbox" id="rotate-toggle" checked class="w-6 h-6"></div>
            <div class="flex justify-between items-center"><span>Warn-T√∂ne</span><input type="checkbox" id="sound-toggle" checked class="w-6 h-6"></div>
        </div>
        <button onclick="toggleSettings()" class="mt-10 w-full bg-blue-600 p-4 rounded-2xl font-black uppercase">Fertig</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYAb-92E5V94UhNVAQl9niTAPkBOBNOjc",
    authDomain: "verkehr-725d5.firebaseapp.com",
    projectId: "verkehr-725d5",
    appId: "1:22824354784:web:90c034d1225dc6837ae185"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let map, userPos, userMarker, tiles;
  let activeMarkers = {};

  // --- INITIALISIERUNG ---
  function init() {
    navigator.geolocation.watchPosition(p => {
      userPos = [p.coords.latitude, p.coords.longitude];
      const speed = Math.round((p.coords.speed || 0) * 3.6);
      
      // Speed Warnung
      const sElem = document.getElementById('speedo');
      document.getElementById('speed-val').innerText = speed;
      sElem.classList.toggle('warning', speed > 50);

      if(!map) {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView(userPos, 16);
        tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        userMarker = L.circleMarker(userPos, { radius: 12, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
        
        // Kompass-Rotation (falls Ger√§t unterst√ºtzt)
        if(window.DeviceOrientationEvent && document.getElementById('rotate-toggle').checked) {
            window.addEventListener('deviceorientationabsolute', e => {
                if(e.alpha) map.setBearing(e.alpha);
            });
        }
        startSync();
      } else {
        userMarker.setLatLng(userPos);
        if(speed > 5) map.panTo(userPos); // Karte folgt nur bei Bewegung
      }
    }, err => {
        document.getElementById('status').innerText = "GPS Fehler";
        document.getElementById('status').classList.replace('text-green-500', 'text-red-500');
    }, { enableHighAccuracy: true });
  }

  // --- FIREBASE SYNC (FIXED) ---
  function startSync() {
    const q = query(collection(db, "reports"), orderBy("time", "desc"), limit(50));
    onSnapshot(q, snap => {
      snap.docChanges().forEach(c => {
        const d = c.doc.data();
        const id = c.doc.id;
        
        if (c.type === "added") {
          const icons = { police: 'üëÆ', speed: 'üì∏', accident: '‚ö†Ô∏è', traffic: 'üöó' };
          const m = L.marker([d.lat, d.lng], {
            icon: L.divIcon({ 
                html: `<div class="text-3xl marker-anim">${icons[d.type] || '‚ùó'}</div>`, 
                className: 'bg-transparent'
            })
          }).addTo(map);
          activeMarkers[id] = m;
          
          // Entfernungs-Check f√ºr Alarm
          const dist = map.distance(userPos, [d.lat, d.lng]);
          if(dist < 1000) triggerAlarm(d.type);
        }
      });
    });
  }

  // --- ACTIONS ---
  async function report(type) {
    if(!userPos) return alert("Warte auf GPS Signal...");
    try {
        await addDoc(collection(db, "reports"), {
            type, lat: userPos[0], lng: userPos[1], time: Date.now()
        });
        if(document.getElementById('sound-toggle').checked) {
            const synth = window.speechSynthesis;
            const utter = new SpeechSynthesisUtterance(type + " gemeldet");
            utter.lang = 'de-DE'; synth.speak(utter);
        }
    } catch(e) { console.error(e); }
  }

  function triggerAlarm(type) {
    const alertBox = document.getElementById('danger-alert');
    alertBox.classList.remove('hidden');
    setTimeout(() => alertBox.classList.add('hidden'), 5000);
  }

  // Event Listener (Das Deep-Binding Fix)
  document.getElementById('p-btn').onclick = () => report('police');
  document.getElementById('s-btn').onclick = () => report('speed');
  document.getElementById('a-btn').onclick = () => report('accident');
  document.getElementById('t-btn').onclick = () => report('traffic');

  window.toggleSettings = () => document.getElementById('settings').classList.toggle('hidden');
  
  window.updTheme = () => {
    const isL = document.getElementById('light-toggle').checked;
    map.removeLayer(tiles);
    tiles = L.tileLayer(isL ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
  };

  init();
</script>

</body>
</html>
